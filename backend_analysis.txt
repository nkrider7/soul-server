
# Backend Analysis

This document provides a summary of the backend application, including its structure, dependencies, and functionality.

## Project Structure

```
/home/narendra/Project /soul-server/
├───.gitignore
├───.prettierrc
├───package-lock.json
├───package.json
├───tsconfig.json
├───.git/...
├───dist/...
├───node_modules/...
├───prisma/
│   ├───schema.prisma
│   └───migrations/
│       ├───migration_lock.toml
│       ├───20250702150442_init/
│       │   └───migration.sql
│       ├───20250716055139_post_schema/
│       │   └───migration.sql
│       ├───20250716153142_remove_profile_from_user/
│       │   └───migration.sql
│       ├───20250721070341_add_verified_to_user/
│       │   └───migration.sql
│       ├───20250721070649_add_verified_to_user/
│       │   └───migration.sql
│       ├───20250803051603_add_challegne_quest_schemea/
│       │   └───migration.sql
│       ├───20250803052407_change_duration_day_to_duration/
│       │   └───migration.sql
│       ├───20250806090236_challenge_quest/
│       │   └───migration.sql
│       ├───20250814160022_character_schema/
│       │   └───migration.sql
│       └───20250814164724_add_user_role/
│           └───migration.sql
├───public/
│   └───temp/
│       └───.gitkeep
└───src/
    ├───index.ts
    ├───controllers/
    │   ├───auth.controller.ts
    │   ├───challenege.controller.ts
    │   ├───character.controller.ts
    │   ├───profile.controller.ts
    │   └───quest.controller.ts
    ├───middleware/
    │   ├───auth.middleware.ts
    │   └───multer.middleware.ts
    ├───routes/
    │   ├───auth.route.ts
    │   ├───challenge.route.ts
    │   ├───character.route.ts
    │   ├───profile.route.ts
    │   └───quest.route.ts
    ├───utils/
    │   ├───cloudinary.ts
    │   ├───logger.ts
    │   └───soulserver_firebase_admin.json
    └───validation/
        ├───challenge.validation.ts
        ├───character.validation.ts
        ├───onboard.validation.ts
        ├───profile.validation.ts
        └───quest.validation.ts
```

## Backend Summary

### 1. Core Technologies

*   **Framework**: Express.js
*   **Database**: PostgreSQL with Prisma as the ORM.
*   **Authentication**: Firebase Admin SDK for user authentication and token verification.
*   **File Uploads**: `multer` for handling multipart/form-data and `cloudinary` for cloud-based image storage.
*   **Validation**: `zod` for robust schema validation.
*   **Logging**: `pino` for structured and performant logging.
*   **Language**: TypeScript

### 2. API Routes

The application exposes the following RESTful API endpoints:

*   **/auth**:
    *   `POST /onboard`: Onboards a new user.
    *   `POST /login`: Logs in an existing user.
    *   `POST /signup`: Signs up a new user.
*   **/profile**: (Requires authentication)
    *   `GET /`: Fetches the user's profile.
    *   `POST /`: Creates a new profile for the user.
    *   `PATCH /`: Updates the user's profile.
*   **/challenge**: (Requires authentication)
    *   `POST /`: Creates a new challenge.
    *   `PATCH /:id`: Updates an existing challenge.
    *   `GET /`: Retrieves all challenges for the user.
    *   `GET /:id`: Retrieves a specific challenge.
*   **/quest**: (Requires authentication)
    *   `POST /:challengeId`: Creates a new quest within a challenge.
    *   `PATCH /:challengeId/:id`: Updates a quest.
    *   `DELETE /:challengeId/:id`: Deletes a quest.
    *   `GET /:challengeId/:id`: Retrieves a specific quest.
    *   `GET /:challengeId`: Retrieves all quests for a challenge.
*   **/character**:
    *   `POST /`: Creates a new character (requires authentication).
    *   `PUT /:id`: Updates a character (requires authentication).
    *   `DELETE /:id`: Deletes a character (requires authentication).
    *   `GET /:id`: Retrieves a specific character.
    *   `GET /`: Retrieves all characters.

### 3. Middleware

*   **`auth.middleware.ts`**: This middleware protects routes by verifying the Firebase ID token provided in the `Authorization` header. It attaches the user object to the request for downstream handlers.
*   **`multer.middleware.ts`**: This middleware handles file uploads, saving them to a temporary directory before they are processed and uploaded to Cloudinary.

### 4. Database Schema

The `prisma/schema.prisma` file defines the following models:

*   **User**: Stores basic user information, including email and authentication details.
*   **Profile**: Contains detailed user profile information, such as name, date of birth, gender, and stats.
*   **Character**: Represents in-game characters with their attributes and images.
*   **Habit**: Stores user habits.
*   **Currency**: Manages user currencies (coins and gems).
*   **Item**: Represents items that can be owned by users.
*   **Posts**: Stores user-created posts.
*   **Challenge**: Defines challenges that users can participate in.
*   **ChallengeQuest**: Represents individual quests within a challenge.

### 5. Validation

The `src/validation` directory contains `zod` schemas for validating incoming request bodies for each of the main API resources. This ensures data integrity and provides clear error messages for invalid requests.
